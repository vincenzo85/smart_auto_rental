services:
  postgres:
    image: postgres:16
    container_name: smart-rental-postgres
    environment:
      POSTGRES_DB: smart_rental
      POSTGRES_USER: smart_user
      POSTGRES_PASSWORD: smart_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U smart_user -d smart_rental"]
      interval: 10s
      timeout: 5s
      retries: 5

  pgadmin:
    image: dpage/pgadmin4:8.14
    container_name: smart-rental-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@smartauto.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      - postgres

  adminer:
    image: adminer:4.8.1
    container_name: smart-rental-adminer
    ports:
      - "8081:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
    depends_on:
      - postgres

  payment-core:
    image: wiremock/wiremock:3.9.1
    container_name: smart-rental-payment-core
    volumes:
      - ./docker/payment-core-mock/mappings:/home/wiremock/mappings:ro
    ports:
      - "8090:8080"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/__admin/mappings >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    build: .
    container_name: smart-rental-app
    environment:
      SPRING_PROFILES_ACTIVE: docker
      APP_INTEGRATIONS_API_KEY: integration-docker-key
      APP_PAYMENT_CORE_MODE: http
      APP_PAYMENT_CORE_BASE_URL: http://payment-core:8080
      APP_PAYMENT_CORE_CHARGE_PATH: /api/v1/core/payments/charge
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      payment-core:
        condition: service_healthy

  agent-orchestrator:
    profiles: ["agents"]
    build:
      context: ./agents
    container_name: smart-rental-agent-orchestrator
    environment:
      AGENT_DEFAULT_MODE: stub
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      OLLAMA_MODEL: qwen2.5-coder:14b
      REPO_ROOT: /workspace
    volumes:
      - ./:/workspace
    ports:
      - "8091:8091"
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  postgres_data:
